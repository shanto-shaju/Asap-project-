{% extends "base.html" %}
{% block title %}Main Dashboard{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
  <!-- Header -->
  <div class="row mb-4 text-center">
    <h2 class="text-primary">Dashboard</h2>
  </div>

  <div class="row">
    <!-- Left Sidebar -->
    <div class="col-md-3 mb-4">
      <div class="d-grid gap-3">
        <button class="btn btn-outline-primary" onclick="showPrivacyPopup()">Password Changer</button>
        <a href="{{ url_for('user_list') }}" class="btn btn-outline-secondary">User List Creation</a>
      </div>
    </div>

    <!-- Right Side Content -->
    <div class="col-md-9">
      <!-- Data Usage -->
      <div class="card mb-4 shadow-sm">
        <div class="card-body">
          <h5 class="card-title">ðŸ“Š Data Usage</h5>
          <p class="card-text">{{ total_used }} USED</p>
        </div>
      </div>

      <!-- Speed Test -->
      <div class="card mb-4 shadow-sm">
        <div class="card-body">
          <h5 class="card-title">âš¡ Speed Test</h5>
          <p id="download">Download: 0 Mbps</p>
          <p id="upload">Upload: 0 Mbps</p>
          <button class="btn btn-primary mt-2" onclick="runSpeedTest()">Start Test</button>
        </div>
      </div>

      <!-- Network Latency -->
      <div class="card shadow-sm mb-4">
        <div class="card-body">
          <h5 class="card-title">ðŸ“¡ Real-Time Latency (ms)</h5>
          <canvas id="latencyChart" height="75"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ======================= JavaScript Section ======================= -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
/* ----------------- SPEED TEST ----------------- */
async function runSpeedTest() {
  const downloadEl = document.getElementById('download');
  const uploadEl = document.getElementById('upload');
  downloadEl.textContent = "Download: Testing...";
  uploadEl.textContent = "Upload: Testing...";

  try {
    // --- Download test ---
    const imageUrl = "https://upload.wikimedia.org/wikipedia/commons/3/3f/Fronalpstock_big.jpg"; // 2MB image
    const startTime = performance.now();
    const response = await fetch(imageUrl + "?cacheBust=" + Math.random());
    const blob = await response.blob();
    const endTime = performance.now();
    const sizeMB = blob.size / (1024 * 1024);
    const durationSec = (endTime - startTime) / 1000;
    const downloadSpeed = (sizeMB / durationSec * 8).toFixed(2);
    downloadEl.textContent = `Download: ${downloadSpeed} Mbps`;

    // --- Upload test ---
    const uploadData = new Blob([new ArrayBuffer(2 * 1024 * 1024)]); // 2MB dummy data
    const uploadStart = performance.now();
    await fetch("https://httpbin.org/post", { method: "POST", body: uploadData });
    const uploadEnd = performance.now();
    const uploadDuration = (uploadEnd - uploadStart) / 1000;
    const uploadSpeed = (2 / uploadDuration * 8).toFixed(2);
    uploadEl.textContent = `Upload: ${uploadSpeed} Mbps`;
  } catch (err) {
    downloadEl.textContent = "Download: Error";
    uploadEl.textContent = "Upload: Error";
  }
}

/* ----------------- LATENCY GRAPH ----------------- */
const ctx = document.getElementById('latencyChart').getContext('2d');
const latencyChart = new Chart(ctx, {
  type: 'line',
  data: { labels: [], datasets: [{ label: 'Ping (ms)', data: [], borderColor: 'rgb(75,192,192)', tension: 0.3 }] },
  options: { animation: false, scales: { y: { beginAtZero: true, max: 500 } } }
});

async function updateLatency() {
  const start = performance.now();
  await fetch('/ping?' + Math.random());
  const latency = performance.now() - start;

  const timeLabel = new Date().toLocaleTimeString();
  latencyChart.data.labels.push(timeLabel);
  latencyChart.data.datasets[0].data.push(latency);

  if (latencyChart.data.labels.length > 20) {
    latencyChart.data.labels.shift();
    latencyChart.data.datasets[0].data.shift();
  }

  latencyChart.update();
}

setInterval(updateLatency, 3000);

/* ----------------- PRIVACY POPUP ----------------- */
function showPrivacyPopup() {
  const modal = new bootstrap.Modal(document.getElementById('privacyModal'));
  modal.show();
}

function redirectToPasswordChanger() {
  window.location.href = "{{ url_for('password_changer') }}";
}
</script>

<!-- Privacy Policy Modal -->
<div class="modal fade" id="privacyModal" tabindex="-1" aria-labelledby="privacyModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="privacyModalLabel">Privacy Policy</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>
          By enabling password changer, you allow the system to update your Wi-Fi password at defined intervals.
          Your data (SSID, brand, interval, and phone number) will be used to send alerts.
        </p>
        <p>Do you agree to proceed?</p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-primary" onclick="redirectToPasswordChanger()">I Agree</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}
